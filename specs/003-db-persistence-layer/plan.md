# Implementation Plan: Database Persistence Layer

**Branch**: `003-db-persistence-layer` | **Date**: 2026-01-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-db-persistence-layer/spec.md`
**Phase**: 2.1

## Summary

Phase 2.1 introduces persistent database storage using SQLModel and Neon Serverless PostgreSQL. This replaces the Phase I in-memory task storage with durable, user-scoped persistence. The implementation is strictly limited to the data access layer—no REST API, authentication, or frontend components are permitted.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: SQLModel, psycopg2-binary, python-dotenv
**Storage**: Neon Serverless PostgreSQL
**Testing**: Manual verification via quickstart.md (formal tests in Phase 2.2)
**Target Platform**: Backend data layer (no HTTP interface)
**Project Type**: Web application (backend only for this phase)
**Performance Goals**: Connection <5s, CRUD operations responsive
**Constraints**: No REST API, No JWT, No frontend, No raw SQL, No migrations
**Scale/Scope**: Single Task entity, user-scoped queries

## Constitution Check

*GATE: Must pass before implementation. All gates verified.*

| Gate | Requirement | Status |
|------|-------------|--------|
| Spec-Driven Development | spec.md exists and is approved | ✅ PASS |
| Phase II Technology | SQLModel + Neon PostgreSQL | ✅ PASS |
| No Spec Bypass | All requirements from spec | ✅ PASS |
| Phase Scope Isolation | Data layer only, no API/auth | ✅ PASS |
| No Manual Coding | Claude Code executor only | ✅ PASS |
| Documentation | plan.md + artifacts complete | ✅ PASS |

**Result**: All constitution gates pass. Proceed to implementation.

## Project Structure

### Documentation (this feature)

```text
specs/003-db-persistence-layer/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technology decisions
├── data-model.md        # Task entity definition
├── quickstart.md        # Verification steps
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task breakdown (generated by /sp.tasks)
```

### Source Code (repository root)

```text
backend/
├── app/
│   ├── __init__.py
│   ├── config.py        # Environment configuration
│   ├── database.py      # Database connection and initialization
│   ├── models/
│   │   ├── __init__.py
│   │   └── task.py      # SQLModel Task entity
│   └── crud/
│       ├── __init__.py
│       └── task.py      # Task CRUD operations
└── tests/               # (Phase 2.2+)
```

**Structure Decision**: Web application structure with backend-only implementation. Frontend directory exists from Phase 2.0 but receives no changes in Phase 2.1.

## Execution Strategy

Phase 2.1 is executed bottom-up at the data layer:

### Phase 1: Infrastructure Setup
**Agent**: database-modeling-agent
**Skills**: neon-postgres-integration, sqlmodel-design

1. Create backend/app directory structure
2. Implement config.py for environment variables
3. Implement database.py for connection management
4. Verify connection to Neon PostgreSQL

### Phase 2: Data Model
**Agent**: database-modeling-agent
**Skills**: sqlmodel-design, relational-data-modeling

1. Define Task SQLModel in models/task.py
2. Implement all fields per data-model.md
3. Add indexes for user_id and created_at
4. Implement table creation function

### Phase 3: Data Access Layer
**Agent**: database-modeling-agent
**Skills**: relational-data-modeling, constraint-enforcement

1. Implement create_task function
2. Implement get_task function
3. Implement get_tasks function (with user_id filter)
4. Implement update_task function
5. Implement delete_task function
6. Implement toggle_complete function

### Phase 4: Validation
**Agent**: phase-orchestrator
**Skills**: constraint-enforcement, spec-interpretation

1. Execute quickstart.md verification steps
2. Verify all success criteria
3. Confirm no API/auth/frontend code
4. Validate Phase I code unchanged

## Agent and Skill Mapping

| Execution Phase | Agent | Skills |
|-----------------|-------|--------|
| Infrastructure | database-modeling-agent | neon-postgres-integration, sqlmodel-design |
| Data Model | database-modeling-agent | sqlmodel-design, relational-data-modeling |
| Data Access | database-modeling-agent | relational-data-modeling, constraint-enforcement |
| Validation | phase-orchestrator | constraint-enforcement, spec-interpretation |

## Scope Constraints (Enforcement)

### MUST Include
- [x] SQLModel Task model with all fields from FR-001
- [x] Database connection via DATABASE_URL
- [x] Table creation function (idempotent)
- [x] CRUD functions (FR-004 through FR-009)
- [x] User-scoped queries via user_id

### MUST NOT Include
- [ ] REST API endpoints (FR-013)
- [ ] JWT verification (FR-014)
- [ ] Frontend code (FR-015)
- [ ] Raw SQL queries (FR-016)
- [ ] Database migrations (FR-017)

## Validation Gates

Before Phase 2.1 is considered complete:

| Gate | Verification Method |
|------|---------------------|
| Tasks persist | Restart app, verify data survives |
| CRUD works | Execute all operations successfully |
| User isolation | Query with different user_ids |
| No API code | grep for FastAPI/Flask imports |
| No auth code | grep for JWT/auth imports |
| Phase I unchanged | git diff src/ shows no changes |

## Dependencies

### Internal
- Phase 2.0 complete (backend/ directory exists)
- Constitution compliance verified

### External
- Neon PostgreSQL account and project
- DATABASE_URL environment variable set

### Libraries
```
sqlmodel>=0.0.14
psycopg2-binary>=2.9.9
python-dotenv>=1.0.0
```

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Neon connection issues | Verify SSL mode, check credentials |
| Schema conflicts | Use create_all() for idempotent creation |
| Scope creep | Strict enforcement of FR-013 to FR-017 |
| Phase I breakage | No modifications to /src directory |

## Next Phase

Successful completion of Phase 2.1 authorizes:
**Phase 2.2 — Backend REST API Layer**

Phase 2.2 will:
- Add FastAPI endpoints for CRUD operations
- Introduce async database operations
- Add Pydantic schemas for request/response
- Integrate with Phase 2.1 data access layer

## Complexity Tracking

> No constitution violations requiring justification.

Phase 2.1 adheres to all simplicity constraints:
- Single entity (Task)
- Standard patterns (SQLModel, context manager sessions)
- No unnecessary abstractions
- Direct implementation from spec
